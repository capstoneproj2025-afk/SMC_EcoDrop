{% extends 'core/base_dashboard.html' %}

{% block title %}Admin Dashboard - EcoDrop{% endblock %}

{% block sidebar %}
<div class="nav-section">
    <div class="nav-title">navigation</div>
    <ul>
        <li><a href="{% url 'admin_dashboard' %}" class="active">Dashboard</a></li>
        <li><a href="{% url 'admin_users' %}">Manage Users</a></li>
        <li><a href="{% url 'admin_user_add' %}">Add User</a></li>
        <li><a href="{% url 'admin_devices' %}">Devices</a></li>
        <li><a href="{% url 'admin_rewards' %}">Rewards</a></li>
    </ul>
</div>
<div class="nav-section" style="margin-top: auto;">
    <ul>
        <li><a href="{% url 'logout' %}" style="color: #e74c3c;">Logout</a></li>
    </ul>
</div>
{% endblock %}

{% block extra_styles %}
<style>
    .admin-header {
        background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        border-left: 4px solid #4a90e2;
    }
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #4a90e2;
        display: block;
    }
    .stat-label {
        color: #666;
        font-size: 0.9rem;
        margin-top: 5px;
    }
    .admin-section {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    .action-btn {
        background: #4a90e2;
        color: white;
        padding: 15px 20px;
        border: none;
        border-radius: 8px;
        text-decoration: none;
        text-align: center;
        transition: all 0.3s ease;
        display: block;
    }
    .action-btn:hover {
        background: #357abd;
        transform: translateY(-2px);
    }
    .table-responsive {
        overflow-x: auto;
        margin-top: 20px;
    }
    .admin-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    .admin-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
    }
    .admin-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
    }
    .admin-table tr:hover {
        background: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<section class="like-panel">
    <h1 style="margin: 0 0 6px;">Admin Dashboard</h1>
    <p style="margin: 0; color: #6b7280;">St. Michael's College EcoDrop System</p>
</section>

<section class="like-panel">
    <h2 style="margin: 0 0 16px;">System Statistics</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-number">{{ total_users }}</span>
            <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
            <span class="stat-number">{{ student_users }}</span>
            <div class="stat-label">Students</div>
        </div>
        <div class="stat-card">
            <span class="stat-number">{{ faculty_users }}</span>
            <div class="stat-label">Faculty</div>
        </div>
        <div class="stat-card">
            <span class="stat-number">{{ total_bottles }}</span>
            <div class="stat-label">Bottles Recycled</div>
        </div>
    </div>
</section>

<section class="like-panel">
    <h2 style="margin: 0 0 16px;">Quick Actions</h2>
    <div class="quick-actions">
        <a href="{% url 'admin_user_add' %}" class="action-btn"><i class="fas fa-user-plus"></i> Add New User</a>
        <a href="{% url 'admin_users' %}" class="action-btn"><i class="fas fa-users-cog"></i> Manage Users</a>
        <a href="{% url 'admin_rewards' %}" class="action-btn"><i class="fas fa-gift"></i> Manage Rewards</a>
        <a href="{% url 'admin_redemptions' %}" class="action-btn"><i class="fas fa-coins"></i> Redemption History</a>
        <a href="{% url 'admin_devices' %}" class="action-btn"><i class="fas fa-microchip"></i> Manage Devices</a>
        <a href="{% url 'admin_full_panel' %}" class="action-btn"><i class="fas fa-cog"></i> Full Admin Panel</a>
    </div>
</section>

<!-- Device Status Overview -->
<section class="like-panel">
    <h2><i class="fas fa-microchip"></i> Device Status Overview</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="text-align: center; padding: 20px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
            <h3 style="color: #28a745; margin-bottom: 10px;">{{ online_devices }}</h3>
            <p style="color: #666; margin: 0;">Online Devices</p>
        </div>
        <div style="text-align: center; padding: 20px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
            <h3 style="color: #dc3545; margin-bottom: 10px;">{{ offline_devices }}</h3>
            <p style="color: #666; margin: 0;">Offline Devices</p>
        </div>
        <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
            <h3 style="color: #ffc107; margin-bottom: 10px;">{{ maintenance_devices }}</h3>
            <p style="color: #666; margin: 0;">Maintenance</p>
        </div>
        <div style="text-align: center; padding: 20px; background: #f1f3f4; border-radius: 8px; border-left: 4px solid #6c757d;">
            <h3 style="color: #6c757d; margin-bottom: 10px;">{{ error_devices }}</h3>
            <p style="color: #666; margin: 0;">Error Status</p>
        </div>
    </div>
</section>

<!-- Device Performance -->
<section class="like-panel">
    <h2><i class="fas fa-chart-line"></i> Top Performing Devices</h2>
    {% if device_performance %}
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Device Name</th>
                        <th>Location</th>
                        <th>Status</th>
                        <th>Total Bottles</th>
                        <th>Recent Activity (7 days)</th>
                        <th>Last Heartbeat</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in device_performance %}
                    <tr>
                        <td><strong>{{ device.device_name }}</strong></td>
                        <td>{{ device.location }}</td>
                        <td>
                            {% if device.status == 'online' %}
                                <span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem;">Online</span>
                            {% elif device.status == 'offline' %}
                                <span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem;">Offline</span>
                            {% elif device.status == 'maintenance' %}
                                <span style="background: #ffc107; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem;">Maintenance</span>
                            {% else %}
                                <span style="background: #6c757d; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem;">{{ device.status|title }}</span>
                            {% endif %}
                        </td>
                        <td><span style="color: #2ecc71; font-weight: bold;">{{ device.total_bottles_processed }}</span></td>
                        <td>{{ device.recent_bottles }}</td>
                        <td>
                            {% if device.last_heartbeat %}
                                {{ device.last_heartbeat|date:"M d, H:i" }}
                            {% else %}
                                <span style="color: #999;">Never</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="text-align: center; color: #666; padding: 20px;">No devices registered yet</p>
    {% endif %}
</section>

<!-- Recent Device Activity -->
<section class="like-panel">
    <h2><i class="fas fa-wrench"></i> Recent Device Activity</h2>
    {% if recent_device_logs %}
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Device</th>
                        <th>Activity Type</th>
                        <th>Result</th>
                        <th>Message</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_device_logs %}
                    <tr>
                        <td>{{ log.created_at|date:"M d, H:i" }}</td>
                        <td>{{ log.device.device_name }}</td>
                        <td>
                            {% if log.log_type == 'bottle_detected' %}
                                <i class="fas fa-search"></i> Detection
                            {% elif log.log_type == 'bottle_sorted' %}
                                <i class="fas fa-check-circle"></i> Sorted
                            {% elif log.log_type == 'error' %}
                                <i class="fas fa-times-circle"></i> Error
                            {% elif log.log_type == 'heartbeat' %}
                                <i class="fas fa-heartbeat"></i> Heartbeat
                            {% else %}
                                <i class="fas fa-wrench"></i> {{ log.log_type|title }}
                            {% endif %}
                        </td>
                        <td>
                            {% if log.sort_result == 'plastic' %}
                                <span style="color: #28a745;"><i class="fas fa-check"></i> Valid Plastic</span>
                            {% elif log.sort_result == 'invalid' %}
                                <span style="color: #dc3545;"><i class="fas fa-times"></i> Invalid</span>
                            {% elif log.sort_result == 'error' %}
                                <span style="color: #ffc107;"><i class="fas fa-exclamation-triangle"></i> Error</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ log.message|truncatechars:50 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="text-align: center; color: #666; padding: 20px;">No recent device activity</p>
    {% endif %}
</section>

<!-- Top Recyclers -->
<section class="like-panel">
    <h2><i class="fas fa-trophy"></i> Top Recyclers</h2>
    {% if top_recyclers %}
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Username</th>
                        <th>Total Points</th>
                        <th>User Type</th>
                    </tr>
                </thead>
                <tbody>
                    {% for profile in top_recyclers %}
                    <tr>
                        <td><strong>{{ forloop.counter }}</strong></td>
                        <td>{{ profile.user.first_name }} {{ profile.user.last_name }}</td>
                        <td>{{ profile.user.username }}</td>
                        <td><span style="color: #2ecc71; font-weight: bold;">{{ profile.total_points }}</span></td>
                        <td>
                            {% if profile.user_type == 'admin' %}
                                <span style="background: #9b59b6; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem;">Admin</span>
                            {% elif profile.user_type == 'teacher' %}
                                <span style="background: #e74c3c; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem;">Teacher</span>
                            {% else %}
                                <span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem;">Student</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="text-align: center; color: #666; padding: 20px;">No users yet</p>
    {% endif %}
</section>

<!-- Recent Transactions -->
<section class="like-panel">
    <h2><i class="fas fa-chart-bar"></i> Recent Transactions</h2>
    {% if recent_transactions %}
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>User</th>
                        <th>Bottles</th>
                        <th>Points Earned</th>
                        <th>QR Code ID</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in recent_transactions %}
                    <tr>
                        <td>{{ transaction.created_at|date:"M d, Y H:i" }}</td>
                        <td>{{ transaction.user_profile.user.first_name }} {{ transaction.user_profile.user.last_name }}</td>
                        <td><i class="fas fa-bottle-water"></i> {{ transaction.no_bottle }}</td>
                        <td><span style="color: #2ecc71; font-weight: bold;">+{{ transaction.points }}</span></td>
                        <td><code style="font-size: 0.8rem;">{{ transaction.user_profile.qr_code_data|truncatechars:20 }}</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="text-align: center; color: #666; padding: 20px;">No transactions yet</p>
    {% endif %}
</section>

<!-- Reward Statistics -->
<section class="like-panel">
    <h2><i class="fas fa-gift"></i> Popular Rewards</h2>
    {% if reward_stats %}
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Reward Item</th>
                        <th>Times Redeemed</th>
                        <th>Total Points Used</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in reward_stats %}
                    <tr>
                        <td>{{ stat.reward_item__reward_name }}</td>
                        <td><strong>{{ stat.count }}</strong></td>
                        <td><span style="color: #e74c3c;">{{ stat.total_points }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="text-align: center; color: #666; padding: 20px;">No redemptions yet</p>
    {% endif %}
</section>

<!-- IoT Integration section hidden - API still works -->
<!-- <section class="like-panel">
    <h2><i class="fas fa-wrench"></i> IoT Integration</h2>
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
        <h4>API Endpoint for EcoDrop Machines:</h4>
        <code style="background: #e9ecef; padding: 15px; border-radius: 6px; display: block; margin: 10px 0;">
            POST {{ request.get_host }}/api/deposit/<br>
            Content-Type: application/json<br><br>
            Body Example:<br>
            {<br>
            &nbsp;&nbsp;"user_id": "SMC-USER-student123-abc12345",<br>
            &nbsp;&nbsp;"bottles": 3<br>
            }
        </code>
        <p style="color: #666; margin-top: 15px;">
            <strong>Note:</strong> This endpoint accepts barcode data from your IoT recycling machines and automatically processes bottle deposits.
        </p>
    </div>
</section> -->

<section class="like-panel">
    <h2><i class="fas fa-chart-pie"></i> Weekly Activity Summary</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <div style="text-align: center; padding: 20px; background: #e8f5e8; border-radius: 8px;">
            <h3 style="color: #27ae60; margin-bottom: 10px;">{{ recent_deposits }}</h3>
            <p style="color: #666;">Bottle Deposits (Last 7 Days)</p>
        </div>
        <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: 8px;">
            <h3 style="color: #f39c12; margin-bottom: 10px;">{{ recent_redemptions }}</h3>
            <p style="color: #666;">Reward Redemptions (Last 7 Days)</p>
        </div>
    </div>
</section>
{% endblock %}
